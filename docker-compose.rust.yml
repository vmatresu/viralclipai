# =============================================================================
# ViralClip AI - Rust Backend Docker Compose
# =============================================================================
# Services:
# - API: Rust Axum backend (vclip-api)
# - Worker: Video processing worker (vclip-worker with FFmpeg)
# - Redis: Job queue and caching
#
# Usage:
#   docker compose -f docker-compose.rust.yml up -d
#   docker compose -f docker-compose.rust.yml logs -f
#   docker compose -f docker-compose.rust.yml down
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Service - Rust Axum Backend
  # ---------------------------------------------------------------------------
  rust-api:
    build:
      context: .
      dockerfile: Dockerfile.rust
      target: runtime
      cache_from:
        - viralclipai-rust-api:latest
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: viralclipai-rust-api:latest
    container_name: viralclipai-rust-api
    restart: unless-stopped

    environment:
      # Rust Runtime
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}

      # API Configuration
      - API_PORT=${API_PORT:-8001}
      - ENVIRONMENT=${ENVIRONMENT:-production}

      # Firebase/Firestore
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}

      # Redis Queue
      - REDIS_URL=redis://rust-redis:6379
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}

      # Cloudflare R2 Storage
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}

      # JWT
      - JWT_SECRET=${JWT_SECRET}

    ports:
      - "${API_PORT:-8001}:8000"

    depends_on:
      rust-redis:
        condition: service_healthy

    networks:
      - viralclipai-rust-network

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
        compress: "true"

  # ---------------------------------------------------------------------------
  # Worker Service - Video Processing with FFmpeg
  # ---------------------------------------------------------------------------
  rust-worker:
    build:
      context: .
      dockerfile: Dockerfile.rust
      target: runtime-ffmpeg
      cache_from:
        - viralclipai-rust-worker:latest
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: viralclipai-rust-worker:latest
    container_name: viralclipai-rust-worker
    restart: unless-stopped

    environment:
      # Rust Runtime
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}

      # Worker Configuration
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}

      # Firebase/Firestore
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}

      # Redis Queue
      - REDIS_URL=redis://rust-redis:6379
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}

      # Cloudflare R2 Storage
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}

      # Gemini AI
      - GEMINI_API_KEY=${GEMINI_API_KEY}

    depends_on:
      rust-redis:
        condition: service_healthy
      rust-api:
        condition: service_healthy

    networks:
      - viralclipai-rust-network

    volumes:
      # Temporary video processing storage
      - rust-worker-temp:/tmp/videos

    # Security (less restrictive for FFmpeg)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
      - SETGID
      - SETUID

    # Resource limits (higher for video processing)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G

    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"

  # ---------------------------------------------------------------------------
  # Redis - Job Queue & Cache
  # ---------------------------------------------------------------------------
  rust-redis:
    image: redis:7-alpine
    container_name: viralclipai-rust-redis
    restart: unless-stopped

    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --tcp-backlog 511
      --timeout 300
      --tcp-keepalive 60

    ports:
      - "${REDIS_PORT:-6380}:6379"

    volumes:
      - rust-redis-data:/data

    networks:
      - viralclipai-rust-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=50m

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "3"
        compress: "true"

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  viralclipai-rust-network:
    name: viralclipai-rust-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  rust-redis-data:
    name: viralclipai-rust-redis-data
    driver: local

  rust-worker-temp:
    name: viralclipai-rust-worker-temp
    driver: local
