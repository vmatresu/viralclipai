# =============================================================================
# Production-Grade Development Docker Compose Configuration
# =============================================================================
# Architecture Principles:
# - SOLID: Single responsibility, production-like even in dev
# - DRY: Reusable configurations, shared volumes
# - Modern: Latest tooling, security best practices
# - Modular: Service isolation, clear dependencies
# - Secure: Non-root, secrets management, network isolation
# - Fast: Optimized builds, hot reload, caching
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API Service (Rust Development) - Performance Optimized
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./rust-backend
      dockerfile: ../Dockerfile.rust
      target: dev
      platform: linux/amd64
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD 2>/dev/null || echo 'dev')}
        VERSION: ${VERSION:-dev}
        BUILDPLATFORM: linux/amd64
        TARGETPLATFORM: linux/amd64
      cache_from:
        - viralclipai-api-rust:dev-cache
      tags:
        - viralclipai-api-rust:dev-cache
    image: viralclipai-api-rust:dev
    pull_policy: build
    container_name: viralclipai-api-rust-dev
    env_file:
      - .env.api.dev.rust
    environment:
      - ENVIRONMENT=development
      - RUST_LOG=debug,hyper=info,tower_http=info
      - LOG_LEVEL=DEBUG
      - CARGO_INCREMENTAL=1
      - RUST_BACKTRACE=full
      # Performance optimizations
      - RUSTFLAGS=-C target-cpu=native -C opt-level=0 -C debuginfo=2
      - CARGO_BUILD_JOBS=${CARGO_BUILD_JOBS:-4}
      - MALLOC_ARENA_MAX=2
      # Connection pooling for better performance
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:password@postgres:5432/viralclipai_dev}
      - DATABASE_MAX_CONNECTIONS=${DATABASE_MAX_CONNECTIONS:-10}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}
      # Application configuration
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret-change-in-production}
      - API_PORT=8000
      - METRICS_PORT=9090
      - HEALTH_CHECK_PORT=8000
      # Development performance settings
      - DEV_MODE=true
      - CACHE_ENABLED=true
      - LOG_JSON=false
    ports:
      - "${API_PORT:-8001}:8000"
      - "${METRICS_PORT:-9091}:9090"
    volumes:
      # Mount Rust source code for hot reload with cargo-watch (delegated for performance)
      - ./rust-backend:/app:cached,delegated
      # Persistent volumes for logs and data
      - api-logs-dev:/app/logs
      - api-videos-dev:/app/videos
      - api-cache-dev:/app/cache
      # Mount Cargo registry cache for faster rebuilds
      - cargo-registry:/usr/local/cargo/registry:cached
      - cargo-git:/usr/local/cargo/git:cached
      - cargo-target:/app/target:cached
    networks:
      - viral-clip-ai-network-dev
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    # Optimized health check with faster intervals for development
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "--max-time",
          "5",
          "http://localhost:8000/health",
          "||",
          "exit",
          "1",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    # Optimized resource limits for development performance
    deploy:
      resources:
        limits:
          cpus: "4.0" # Rust compilation is CPU intensive
          memory: 4G # Memory for compilation and runtime
        reservations:
          cpus: "1.0"
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    # Security: read-only root filesystem with performance-optimized exceptions
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=200m
      - /app/target/debug:rw,noexec,nosuid,size=2g
    # High-performance logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service=api-rust,environment=development,version=dev"
        env: "RUST_LOG"
        env-regex: "^RUST_"
    # Security hardening with performance considerations
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - SYS_PTRACE # For debugging
    # Development debugging and performance monitoring
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.localhost`)"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      - "com.docker.compose.profile=development"
    # Performance profiling ports
    profiles:
      - development
      - performance

  # ---------------------------------------------------------------------------
  # PostgreSQL Database (Development)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: viralclipai-postgres-dev
    environment:
      - POSTGRES_DB=viralclipai_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - postgres-data-dev:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - viral-clip-ai-network-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d viralclipai_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=postgres,environment=development"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Redis Cache (Development)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: viralclipai-redis-dev
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_PORT:-6380}:6379"
    volumes:
      - redis-data-dev:/data
    networks:
      - viral-clip-ai-network-dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=redis,environment=development"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Frontend Web Service (Development)
  # ---------------------------------------------------------------------------
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: dev
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD 2>/dev/null || echo 'dev')}
        VERSION: ${VERSION:-dev}
    image: viralclipai-web:dev
    pull_policy: build
    container_name: viralclipai-web-dev
    env_file:
      - web/.env.local
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_BASE_URL=http://api:8000
      - NEXT_PUBLIC_ENVIRONMENT=development
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      - NEXT_TELEMETRY_DISABLED=1
    ports:
      - "${WEB_PORT:-3002}:3000"
      - "${WEB_DEBUG_PORT:-9229}:9229" # Node.js debugger
    volumes:
      # Mount source code for hot reload
      - ./web:/app:cached
      # Exclude generated files
      - /app/node_modules
      - /app/.next
      - /app/out
      # Cache directories for faster rebuilds
      - web-node-cache:/app/.cache
      - web-yarn-cache:/usr/local/share/.cache/yarn
    networks:
      - viral-clip-ai-network-dev
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    # Health check for Next.js
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:3000/api/health",
          "||",
          "exit",
          "1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Production-like resource limits for development stability
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    # Security: read-only root filesystem with exceptions
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
      - /app/.next/cache:rw,noexec,nosuid,size=500m
    # Comprehensive logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service=web,environment=development,version=dev"
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Development debugging and monitoring
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`web.localhost`)"
      - "traefik.http.services.web.loadbalancer.server.port=3000"

  # ---------------------------------------------------------------------------
  # Monitoring & Observability Stack (Development)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: viralclipai-prometheus-dev
    ports:
      - "${PROMETHEUS_PORT:-9092}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data-dev:/prometheus
    networks:
      - viral-clip-ai-network-dev
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--storage.tsdb.retention.time=200h"
      - "--web.enable-lifecycle"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=prometheus,environment=development"
    security_opt:
      - no-new-privileges:true

  grafana:
    image: grafana/grafana:latest
    container_name: viralclipai-grafana-dev
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    ports:
      - "${GRAFANA_PORT:-3003}:3000"
    volumes:
      - grafana-data-dev:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - viral-clip-ai-network-dev
    depends_on:
      - prometheus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=grafana,environment=development"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Performance Monitoring & Profiling Tools
  # ---------------------------------------------------------------------------
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: viralclipai-jaeger-dev
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    ports:
      - "${JAEGER_PORT:-16686}:16686"
      - "${JAEGER_OTLP_PORT:-4318}:4318"
    networks:
      - viral-clip-ai-network-dev
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=jaeger,environment=development"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Development Tools & Utilities
  # ---------------------------------------------------------------------------
  adminer:
    image: adminer:latest
    container_name: viralclipai-adminer-dev
    ports:
      - "${ADMINER_PORT:-8081}:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
    networks:
      - viral-clip-ai-network-dev
    depends_on:
      - postgres
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "3"
        labels: "service=adminer,environment=development"
    security_opt:
      - no-new-privileges:true

  redis-insight:
    image: redis/redisinsight:latest
    container_name: viralclipai-redis-insight-dev
    ports:
      - "${REDIS_INSIGHT_PORT:-8002}:8001"
    volumes:
      - redis-insight-data-dev:/db
    networks:
      - viral-clip-ai-network-dev
    depends_on:
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "3"
        labels: "service=redis-insight,environment=development"
    security_opt:
      - no-new-privileges:true

# -----------------------------------------------------------------------------
# Networks - Isolated development network with security
# -----------------------------------------------------------------------------
networks:
  viral-clip-ai-network-dev:
    driver: bridge
    name: viral-clip-ai-network-dev
    driver_opts:
      com.docker.network.bridge.name: br-viralclipai-dev
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    labels:
      - "environment=development"
      - "project=viralclipai"

# -----------------------------------------------------------------------------
# Volumes - Persistent storage with proper naming and labels
# -----------------------------------------------------------------------------
volumes:
  # API Service Volumes
  api-logs-dev:
    name: viral-clip-ai-api-logs-dev
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./logs/api
    labels:
      - "service=api"
      - "environment=development"
      - "type=logs"

  api-videos-dev:
    name: viral-clip-ai-api-videos-dev
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./videos
    labels:
      - "service=api"
      - "environment=development"
      - "type=data"

  api-cache-dev:
    name: viral-clip-ai-api-cache-dev
    driver: local
    labels:
      - "service=api"
      - "environment=development"
      - "type=cache"

  # Cargo Build Cache Volumes
  cargo-registry:
    name: viral-clip-ai-cargo-registry
    driver: local
    labels:
      - "service=api"
      - "environment=development"
      - "type=build-cache"
      - "tool=cargo"

  cargo-git:
    name: viral-clip-ai-cargo-git
    driver: local
    labels:
      - "service=api"
      - "environment=development"
      - "type=build-cache"
      - "tool=cargo"

  cargo-target:
    name: viral-clip-ai-cargo-target
    driver: local
    labels:
      - "service=api"
      - "environment=development"
      - "type=build-cache"
      - "tool=cargo"

  # Database Volumes
  postgres-data-dev:
    name: viral-clip-ai-postgres-data-dev
    driver: local
    labels:
      - "service=postgres"
      - "environment=development"
      - "type=database"

  # Cache Service Volumes
  redis-data-dev:
    name: viral-clip-ai-redis-data-dev
    driver: local
    labels:
      - "service=redis"
      - "environment=development"
      - "type=cache"

  # Frontend Volumes
  web-node-cache:
    name: viral-clip-ai-web-node-cache-dev
    driver: local
    labels:
      - "service=web"
      - "environment=development"
      - "type=build-cache"
      - "tool=node"

  web-yarn-cache:
    name: viral-clip-ai-web-yarn-cache-dev
    driver: local
    labels:
      - "service=web"
      - "environment=development"
      - "type=build-cache"
      - "tool=yarn"

  # Monitoring Volumes
  prometheus-data-dev:
    name: viral-clip-ai-prometheus-data-dev
    driver: local
    labels:
      - "service=prometheus"
      - "environment=development"
      - "type=metrics"

  grafana-data-dev:
    name: viral-clip-ai-grafana-data-dev
    driver: local
    labels:
      - "service=grafana"
      - "environment=development"
      - "type=dashboards"

  # Development Tool Volumes
  redis-insight-data-dev:
    name: viral-clip-ai-redis-insight-data-dev
    driver: local
    labels:
      - "service=redis-insight"
      - "environment=development"
      - "type=config"

  # Performance Monitoring Volumes
  jaeger-data-dev:
    name: viral-clip-ai-jaeger-data-dev
    driver: local
    labels:
      - "service=jaeger"
      - "environment=development"
      - "type=tracing"
