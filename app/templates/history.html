<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History - Viral Clip AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              gray: {
                900: "#121212",
                800: "#1e1e1e",
                700: "#2d2d2d",
              },
            },
          },
        },
      };
    </script>
    <style>
      .glass {
        background: rgba(30, 30, 30, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen font-sans antialiased">
    {% include 'base.html' %}

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 pt-24 pb-12 space-y-8">
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-white">Processing History</h1>
      </div>

      <div id="historyContainer" class="grid gap-4">
        <div
          class="text-center py-12 text-gray-500 text-lg"
          id="historyLoading"
        >
          Loading your processing history...
        </div>
      </div>
    </main>
    <script>
      async function loadHistory() {
        const container = document.getElementById("historyContainer");
        const loading = document.getElementById("historyLoading");
        if (!container) return;
        try {
          const token = await (window.authGetCurrentIdToken
            ? window.authGetCurrentIdToken(false)
            : Promise.resolve(null));
          if (!token) {
            if (loading) {
              loading.textContent = "Please sign in to view your history.";
            }
            return;
          }
          const res = await fetch("/api/user/videos", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          if (!res.ok) {
            throw new Error("Failed to load history");
          }
          const data = await res.json();
          const videos = data.videos || [];
          container.innerHTML = "";
          if (videos.length === 0) {
            container.innerHTML =
              '<div class="text-center py-12 text-gray-500 text-lg">No history found.</div>';
            return;
          }
          videos.forEach((v) => {
            const a = document.createElement("a");
            a.href = `/?id=${encodeURIComponent(v.video_id || v.id || "")}`;
            a.className =
              "glass p-6 rounded-xl hover:bg-gray-800 transition-all group block border-l-4 border-transparent hover:border-blue-500";
            const title = v.video_title || "Generated Clips";
            const url = v.video_url || "";
            const createdAt = v.created_at || "";
            a.innerHTML = `
              <div class="flex items-start justify-between">
                <div>
                  <h3 class="text-lg font-bold text-white group-hover:text-blue-400 transition-colors mb-1">${title}</h3>
                  <div class="text-sm text-gray-400 font-mono mb-2">${
                    v.video_id || v.id || ""
                  }</div>
                  <div class="text-sm text-gray-500 truncate max-w-md">${url}</div>
                </div>
                <div class="text-xs text-gray-500 font-mono bg-gray-800 px-2 py-1 rounded border border-gray-700">
                  ${createdAt}
                </div>
              </div>`;
            container.appendChild(a);
          });
        } catch (err) {
          console.error(err);
          if (loading) {
            loading.textContent = "Error loading history.";
          }
        }
      }

      window.addEventListener("DOMContentLoaded", loadHistory);
    </script>
  </body>
</html>
