<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - Viral Clip AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              gray: {
                900: "#121212",
                800: "#1e1e1e",
                700: "#2d2d2d",
              },
            },
          },
        },
      };
    </script>
    <style>
      .glass {
        background: rgba(30, 30, 30, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen font-sans antialiased">
    {% include 'base.html' %}

    <main class="max-w-3xl mx-auto px-4 pt-24 pb-12 space-y-8">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold text-white">Account Settings</h1>
      </div>

      <section class="glass rounded-2xl p-6 space-y-4">
        <h2 class="text-xl font-semibold text-white">Plan & Usage</h2>
        <div id="planInfo" class="text-sm text-gray-300">
          Loading plan information...
        </div>
      </section>

      <section class="glass rounded-2xl p-6 space-y-4">
        <h2 class="text-xl font-semibold text-white">TikTok Integration</h2>
        <p class="text-sm text-gray-400">
          Connect your TikTok account by providing the access token and account
          ID from your TikTok developer application. These values are stored
          securely in Firestore and used only to publish clips you explicitly
          choose.
        </p>
        <form id="settingsForm" class="space-y-4">
          <div>
            <label
              class="block text-xs font-semibold text-gray-400 uppercase mb-1"
              >TikTok Access Token</label
            >
            <input
              id="tiktokAccessToken"
              type="password"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none"
              placeholder="Paste your TikTok access token"
            />
          </div>
          <div>
            <label
              class="block text-xs font-semibold text-gray-400 uppercase mb-1"
              >TikTok Account ID</label
            >
            <input
              id="tiktokAccountId"
              type="text"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none"
              placeholder="Your TikTok account ID or advertiser ID"
            />
          </div>
          <div class="flex items-center justify-between mt-4">
            <div id="settingsStatus" class="text-sm text-gray-400"></div>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-semibold transition-colors"
            >
              Save Settings
            </button>
          </div>
        </form>
      </section>
    </main>

    <script>
      async function loadSettings() {
        const planInfo = document.getElementById("planInfo");
        const accessTokenInput = document.getElementById("tiktokAccessToken");
        const accountIdInput = document.getElementById("tiktokAccountId");
        const statusEl = document.getElementById("settingsStatus");
        try {
          const token = await (window.authGetCurrentIdToken
            ? window.authGetCurrentIdToken(false)
            : Promise.resolve(null));
          if (!token) {
            if (planInfo) {
              planInfo.textContent = "Please sign in to view your settings.";
            }
            if (statusEl) {
              statusEl.textContent = "";
            }
            return;
          }
          const res = await fetch("/api/settings", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          if (!res.ok) {
            throw new Error("Failed to load settings");
          }
          const data = await res.json();
          const plan = data.plan || "free";
          const maxClips = data.max_clips_per_month ?? 0;
          const used = data.clips_used_this_month ?? 0;
          const settings = data.settings || {};
          if (planInfo) {
            planInfo.innerHTML = `
              <div class="space-y-1">
                <div><span class="font-semibold">Plan:</span> <span class="uppercase text-blue-400 text-xs">${plan}</span></div>
                <div><span class="font-semibold">Monthly Clips:</span> ${used} / ${maxClips}</div>
              </div>`;
          }
          if (accessTokenInput) {
            accessTokenInput.value = settings.tiktok_access_token || "";
          }
          if (accountIdInput) {
            accountIdInput.value = settings.tiktok_account_id || "";
          }
          if (statusEl) {
            statusEl.textContent = "Settings loaded.";
          }
        } catch (err) {
          console.error(err);
          if (planInfo) {
            planInfo.textContent = "Error loading settings.";
          }
          if (statusEl) {
            statusEl.textContent = "";
          }
        }
      }

      async function saveSettings(event) {
        event.preventDefault();
        const accessTokenInput = document.getElementById("tiktokAccessToken");
        const accountIdInput = document.getElementById("tiktokAccountId");
        const statusEl = document.getElementById("settingsStatus");
        try {
          const token = await (window.authGetCurrentIdToken
            ? window.authGetCurrentIdToken(false)
            : Promise.resolve(null));
          if (!token) {
            alert("Please sign in to save settings.");
            return;
          }
          const payload = {
            settings: {
              tiktok_access_token: accessTokenInput.value || "",
              tiktok_account_id: accountIdInput.value || "",
            },
          };
          const res = await fetch("/api/settings", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || "Failed to save settings");
          }
          if (statusEl) {
            statusEl.textContent = "Settings saved.";
          }
        } catch (err) {
          console.error(err);
          alert("Error saving settings. Check console for details.");
          if (statusEl) {
            statusEl.textContent = "";
          }
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        loadSettings();
        const form = document.getElementById("settingsForm");
        if (form) {
          form.addEventListener("submit", saveSettings);
        }
      });
    </script>
  </body>
</html>
