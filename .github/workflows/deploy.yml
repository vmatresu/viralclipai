name: Deploy Backend to DigitalOcean Droplet

on:
  push:
    branches:
    - main
    paths:
    - 'backend/**'
    - 'docker-compose.yml'
    - 'Dockerfile*'
    - 'Makefile'
    - '.env.example'
    - 'firestore.rules'
    - 'firestore.indexes.json'

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Security Check - Run before deployment
  # ---------------------------------------------------------------------------
  pre-deploy-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Validate docker-compose config
        run: docker compose -f docker-compose.yml config --quiet

      - name: Check for secrets in code
        run: |
          if grep -rE '(password|secret|key)\s*=\s*["\x27][^${}][^"\x27]+["\x27]' \
            --include='*.yml' --include='*.yaml' --include='*.json' \
            --exclude-dir=node_modules --exclude-dir=target . 2>/dev/null | \
            grep -v '.example' | grep -v 'REDIS_PASSWORD:-changeme'; then
            echo "::warning::Potential hardcoded secrets found. Please review."
          fi

  # ---------------------------------------------------------------------------
  # Deploy Backend
  # ---------------------------------------------------------------------------
  deploy-backend:
    needs: pre-deploy-check
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: production-deploy
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Deploy backend over SSH
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262  # v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          port: ${{ secrets.DO_PORT }}
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -euo pipefail

            # Backend application directory on droplet
            APP_DIR=/var/www/viralclipai-backend
            BACKUP_DIR=/var/www/backups/$(date +%Y%m%d_%H%M%S)

            if [ ! -d "$APP_DIR" ]; then
              echo "Backend app directory $APP_DIR does not exist on droplet" >&2
              exit 1
            fi

            cd "$APP_DIR"

            # Create backup of current deployment
            echo "Creating backup..."
            mkdir -p /var/www/backups
            docker compose ps -q > /dev/null 2>&1 && \
              docker compose config > "$BACKUP_DIR-compose.yml" || true

            # Pull latest code from main
            echo "Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            # Verify environment file exists
            if [ ! -f .env ]; then
              echo "ERROR: .env file not found!" >&2
              exit 1
            fi

            # Build and deploy backend services
            echo "Building and deploying services..."
            docker compose -f docker-compose.yml pull || true
            docker compose -f docker-compose.yml up -d --build api worker redis

            # Wait for services to be healthy
            echo "Waiting for backend services to be healthy..."
            TIMEOUT=300
            ELAPSED=0
            while [ $ELAPSED -lt $TIMEOUT ]; do
              API_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' vclip-api 2>/dev/null || echo "starting")
              REDIS_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' vclip-redis 2>/dev/null || echo "starting")
              
              if [ "$API_HEALTH" = "healthy" ] && [ "$REDIS_HEALTH" = "healthy" ]; then
                echo "All services healthy!"
                break
              fi
              
              echo "Waiting... API: $API_HEALTH, Redis: $REDIS_HEALTH"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done

            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "WARNING: Timeout waiting for services to become healthy"
              docker compose logs --tail=50 api worker redis
            fi

            # Verify API is responding
            echo "Verifying API health endpoint..."
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "API health check passed!"
            else
              echo "WARNING: API health check failed"
            fi

            # Clean up old images (keep last 3)
            echo "Cleaning up old images..."
            docker image prune -f || true
            
            # Keep only last 5 backups
            ls -dt /var/www/backups/* 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true

            echo "=========================================="
            echo "Backend deployment completed successfully!"
            echo "=========================================="

