name: Deploy Worker to Production

on:
  push:
    branches: [ main ]
    paths:
    - 'backend/**'
    - 'Dockerfile'
    - 'deploy/docker-compose.worker.yml'
    - 'deploy/scripts/**'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for this deployment (optional)'
        required: false
        type: string
        default: 'Manual deployment'

run-name: Deploy Worker to Production${{ inputs.reason && format(' - {0}', inputs.reason) || '' }}

permissions:
  contents: read

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: worker-deploy
      cancel-in-progress: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

    - name: Deploy Worker via SSH
      uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
      with:
        host: ${{ vars.WORKER_HOST }}
        username: ${{ vars.SSH_USER }}
        port: ${{ vars.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        command_timeout: 30m
        script: |
          set -euo pipefail

          APP_DIR=/var/www/viralclipai-backend
          cd "$APP_DIR"

          test -f /var/www/viralclipai-backend/.env
          test -f /var/www/viralclipai-backend/firebase-credentials.json

          echo "Pulling latest changes..."
          git fetch origin main
          git reset --hard origin/main

          echo "Starting Worker build in background..."
          # Run build in background so GH Actions doesn't wait for full compile
          nohup bash -c '
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            # Force remove existing container to prevent conflicts
            docker rm -f vclip-worker 2>/dev/null || true
            docker compose --env-file .env -f deploy/docker-compose.worker.yml up -d --build --force-recreate 2>&1 | tee /tmp/worker-deploy.log
            docker image prune -f || true

            # Wait for container to start before assigning IPv6 addresses
            echo "Waiting 60s for container to stabilize..."
            sleep 60

            # Check if container is running
            if ! docker ps | grep -q vclip-worker; then
                echo "⚠️ Container vclip-worker is NOT running! Fetching logs..."
                docker logs vclip-worker 2>&1 | tail -n 50 | tee -a /tmp/worker-deploy.log
            fi

            # Assign IPv6 addresses for IP rotation (if script exists and IPv6 is configured)
            if [ -f /usr/local/bin/assign-ipv6.sh ] && [ -f /etc/viralclip/ipv6.conf ]; then
              echo "Assigning 10,000 random IPv6 addresses..."
              sudo /usr/local/bin/assign-ipv6.sh assign 2>&1 | tee -a /tmp/worker-deploy.log || echo "⚠️ IPv6 assignment failed (non-critical)"
              echo "Verifying IPv6 assignment..."
              sudo /usr/local/bin/assign-ipv6.sh verify 2>&1 | tee -a /tmp/worker-deploy.log || true
            else
              echo "ℹ️ IPv6 rotation not configured (assign-ipv6.sh or ipv6.conf missing)"
            fi
          ' > /tmp/worker-deploy-wrapper.log 2>&1 &
          disown

          echo "✅ Build triggered in background. Monitor with: ssh ${{ vars.SSH_USER }}@${{ vars.WORKER_HOST }} 'tail -f /tmp/worker-deploy.log'"
