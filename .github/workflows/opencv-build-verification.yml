# =============================================================================
# OpenCV Build Verification Workflow
# =============================================================================
# Verifies that OpenCV artifacts are correctly built with:
#   - OpenVINO backend enabled
#   - Correct CPU baseline (AVX2)
#   - TBB threading enabled
#   - Required modules built (DNN, objdetect, face)
#
# This workflow runs after opencv-build.yml or on demand to validate artifacts.
# =============================================================================

name: OpenCV Build Verification

on:
  workflow_dispatch:
    inputs:
      artifact_name:
        description: 'Name of the artifact to verify'
        required: false
        default: 'opencv-4.12.0-openvino-portable'

  workflow_run:
    workflows: [ "OpenCV Build" ]
    types:
    - completed

jobs:
  verify-build:
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download portable artifact
      if: ${{ github.event_name == 'workflow_dispatch' }}
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}
        path: opencv-artifacts/
      continue-on-error: true

    - name: Download artifact from workflow run
      if: ${{ github.event_name == 'workflow_run' }}
      uses: actions/download-artifact@v4
      with:
        name: opencv-4.12.0-openvino-portable
        path: opencv-artifacts/
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
      continue-on-error: true

    - name: Extract OpenCV artifacts
      run: |
        if [ -f opencv-artifacts/opencv-*.tar.gz ]; then
          sudo mkdir -p /usr/local
          sudo tar -xzf opencv-artifacts/opencv-*.tar.gz -C /usr/local
          sudo ldconfig
          echo "OpenCV artifacts extracted successfully"
        else
          echo "No OpenCV artifacts found, using system OpenCV for testing"
        fi

    - name: Install Python dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-opencv python3-numpy

    - name: Verify OpenVINO backend
      run: |
        python3 << 'EOF'
        import cv2
        import sys

        print("=" * 60)
        print("OpenCV Build Verification")
        print("=" * 60)

        # Get build info
        info = cv2.getBuildInformation()
        print(info)

        # Verification checks
        errors = []

        # Check 1: OpenVINO backend
        if 'OpenVINO:' in info:
            ov_line = [l for l in info.split('\n') if 'OpenVINO:' in l][0]
            if 'YES' in ov_line.upper():
                print("✅ OpenVINO: ENABLED")
            else:
                errors.append("OpenVINO is not enabled in build")
                print("❌ OpenVINO: DISABLED")
        else:
            print("⚠️  OpenVINO: NOT FOUND (may be OK for system OpenCV)")

        # Check 2: CPU Baseline
        if 'CPU_BASELINE:' in info:
            baseline_line = [l for l in info.split('\n') if 'CPU_BASELINE:' in l][0]
            if 'AVX2' in baseline_line:
                print("✅ CPU Baseline: AVX2")
            else:
                errors.append(f"CPU baseline is not AVX2: {baseline_line}")
                print(f"❌ CPU Baseline: {baseline_line}")
        else:
            print("⚠️  CPU_BASELINE: NOT FOUND")

        # Check 3: TBB Threading
        if 'TBB:' in info:
            tbb_line = [l for l in info.split('\n') if 'TBB:' in l][0]
            if 'YES' in tbb_line.upper():
                print("✅ TBB Threading: ENABLED")
            else:
                errors.append("TBB threading is not enabled")
                print("❌ TBB Threading: DISABLED")
        else:
            print("⚠️  TBB: NOT FOUND")

        # Check 4: DNN Module
        try:
            net = cv2.dnn.readNet.__doc__
            print("✅ DNN Module: AVAILABLE")
        except AttributeError:
            errors.append("DNN module not available")
            print("❌ DNN Module: NOT AVAILABLE")

        # Check 5: FaceDetectorYN (objdetect module)
        try:
            detector = cv2.FaceDetectorYN
            print("✅ FaceDetectorYN: AVAILABLE")
        except AttributeError:
            errors.append("FaceDetectorYN not available")
            print("❌ FaceDetectorYN: NOT AVAILABLE")

        print("=" * 60)

        if errors:
            print("VERIFICATION FAILED:")
            for e in errors:
                print(f"  - {e}")
            sys.exit(1)
        else:
            print("VERIFICATION PASSED: All checks successful")
            sys.exit(0)
        EOF

    - name: Store build info artifact
      run: |
        mkdir -p verification-results
        if [ -f opencv-artifacts/opencv-build-info.txt ]; then
          cp opencv-artifacts/opencv-build-info.txt verification-results/
        fi
        python3 -c "import cv2; print(cv2.getBuildInformation())" > verification-results/opencv-runtime-info.txt

        echo "=== Verification Results ===" | tee verification-results/summary.txt
        echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" | tee -a verification-results/summary.txt
        echo "OpenCV Version: $(python3 -c 'import cv2; print(cv2.__version__)')" | tee -a verification-results/summary.txt

    - name: Upload verification results
      uses: actions/upload-artifact@v4
      with:
        name: opencv-verification-results
        path: verification-results/
        retention-days: 30

  # ===========================================================================
  # Test YuNet inference with verified OpenCV
  # ===========================================================================
  test-yunet-inference:
    needs: verify-build
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download OpenCV artifacts
      uses: actions/download-artifact@v4
      with:
        name: opencv-4.12.0-openvino-portable
        path: opencv-artifacts/
      continue-on-error: true

    - name: Extract OpenCV artifacts
      run: |
        if [ -f opencv-artifacts/opencv-*.tar.gz ]; then
          sudo mkdir -p /usr/local
          sudo tar -xzf opencv-artifacts/opencv-*.tar.gz -C /usr/local
          sudo ldconfig
        fi

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-opencv python3-numpy curl

    - name: Download YuNet model
      run: |
        mkdir -p models
        curl -L -o models/face_detection_yunet_2023mar.onnx \
          "https://github.com/opencv/opencv_zoo/raw/main/models/face_detection_yunet/face_detection_yunet_2023mar.onnx"

    - name: Test YuNet inference
      run: |
        python3 << 'EOF'
        import cv2
        import numpy as np
        import time

        print("=" * 60)
        print("YuNet Inference Test")
        print("=" * 60)

        # Create test image with a simple face-like pattern
        img = np.zeros((480, 640, 3), dtype=np.uint8)
        img[:] = (128, 128, 128)  # Gray background

        # Draw a simple face-like oval
        cv2.ellipse(img, (320, 240), (80, 100), 0, 0, 360, (255, 220, 180), -1)
        cv2.circle(img, (290, 220), 15, (50, 50, 50), -1)  # Left eye
        cv2.circle(img, (350, 220), 15, (50, 50, 50), -1)  # Right eye
        cv2.ellipse(img, (320, 280), (30, 15), 0, 0, 180, (150, 100, 100), -1)  # Mouth

        print(f"Test image shape: {img.shape}")

        # Initialize YuNet detector
        try:
            detector = cv2.FaceDetectorYN.create(
                "models/face_detection_yunet_2023mar.onnx",
                "",
                (640, 480),
                0.3,  # score threshold
                0.3,  # nms threshold
                10    # top_k
            )
            print("✅ YuNet detector created successfully")
        except Exception as e:
            print(f"❌ Failed to create YuNet detector: {e}")
            exit(1)

        # Run inference with timing
        num_runs = 10
        times = []

        for i in range(num_runs):
            start = time.perf_counter()
            _, faces = detector.detect(img)
            elapsed = (time.perf_counter() - start) * 1000
            times.append(elapsed)
            if i == 0:
                print(f"First inference: {elapsed:.2f}ms")

        avg_time = sum(times[1:]) / (num_runs - 1)  # Exclude warmup
        print(f"Average inference time (excluding warmup): {avg_time:.2f}ms")
        print(f"Min: {min(times[1:]):.2f}ms, Max: {max(times[1:]):.2f}ms")

        if faces is not None:
            print(f"✅ Detected {len(faces)} face(s)")
        else:
            print("⚠️  No faces detected (expected for synthetic test image)")

        print("=" * 60)
        print("YuNet Inference Test: PASSED")
        EOF
