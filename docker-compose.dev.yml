# =============================================================================
# Development Docker Compose Configuration
# =============================================================================
# Best Practices:
# - Volume mounts for hot reload
# - Development-friendly settings
# - Debugging tools enabled
# - Less restrictive resource limits
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API Service (Development)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD 2>/dev/null || echo 'dev')}
        VERSION: ${VERSION:-dev}
    image: viralclipai-api:dev
    pull_policy: build
    container_name: viralclipai-api-dev
    env_file:
      - .env.api.dev
    environment:
      - ENVIRONMENT=development
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    ports:
      - "${API_PORT:-8001}:8000"
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Exclude node_modules and other build artifacts
      - /app/venv
      - /app/__pycache__
      - /app/.pytest_cache
      # Persistent volumes for logs and videos
      - api-logs-dev:/app/logs
      - api-videos-dev:/app/videos
    networks:
      - viral-clip-ai-network-dev
    restart: unless-stopped
    # Development: more permissive resource limits
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
    # Development: allow file writes
    read_only: false
    # Logging for development
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=api,environment=development"

  # ---------------------------------------------------------------------------
  # Frontend Web Service (Development)
  # ---------------------------------------------------------------------------
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: dev
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD 2>/dev/null || echo 'dev')}
        VERSION: ${VERSION:-dev}
    image: viralclipai-web:dev
    pull_policy: build
    container_name: viralclipai-web-dev
    env_file:
      - web/.env.local
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_BASE_URL=http://api:8000
      - WATCHPACK_POLLING=true  # Enable polling for file changes in Docker
    ports:
      - "${WEB_PORT:-3002}:3000"
    volumes:
      # Mount source code for hot reload
      - ./web:/app
      # Exclude node_modules to use container's version
      - /app/node_modules
      - /app/.next
    networks:
      - viral-clip-ai-network-dev
    depends_on:
      - api
    restart: unless-stopped
    # Development: more permissive resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
    # Development: allow file writes
    read_only: false
    # Logging for development
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=web,environment=development"

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  viral-clip-ai-network-dev:
    driver: bridge
    name: viral-clip-ai-network-dev

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  api-logs-dev:
    name: viral-clip-ai-api-logs-dev
    driver: local
  api-videos-dev:
    name: viral-clip-ai-api-videos-dev
    driver: local
