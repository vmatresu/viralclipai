# =============================================================================
# Development Docker Compose - Backend Only
# =============================================================================
# Minimal development setup for backend services
# Frontend runs separately: npm run dev in web/
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Service - Development with Hot Reload
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./backend
      dockerfile: ../Dockerfile
      target: dev
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD 2>/dev/null || echo 'dev')}
        VERSION: ${VERSION:-dev}
    image: viralclipai-api:dev
    container_name: viralclipai-api-dev

    env_file:
      - .env.dev

    environment:
      # Development
      - ENVIRONMENT=development
      - RUST_LOG=debug,hyper=info,tower_http=info
      - LOG_LEVEL=DEBUG
      - RUST_BACKTRACE=full

      # GCP Credentials
      - GOOGLE_APPLICATION_CREDENTIALS=/firebase-credentials.json

      # API
      - API_PORT=8000

      # Redis
      - REDIS_URL=redis://redis:6379

    ports:
      - "${API_PORT:-8000}:8000"

    volumes:
      # Mount source code for hot reload
      - ./backend:/app
      # Exclude target directory (build artifacts)
      - /app/target
      # Mount Firebase credentials
      - ./firebase-credentials.json:/firebase-credentials.json

    networks:
      - viralclipai-dev-network

    depends_on:
      redis:
        condition: service_healthy

    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Redis - Job Queue & Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: viralclipai-redis-dev
    restart: unless-stopped

    command: redis-server --appendonly yes

    ports:
      - "${REDIS_PORT:-6379}:6379"

    volumes:
      - redis-dev-data:/data

    networks:
      - viralclipai-dev-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  viralclipai-dev-network:
    name: viralclipai-dev-network
    driver: bridge

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  redis-dev-data:
    name: viralclipai-redis-dev-data
    driver: local
