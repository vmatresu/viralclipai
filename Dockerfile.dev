# =============================================================================
# Development Dockerfile - Optimized for Apple Silicon (ARM64)
# =============================================================================
# Native ARM64 builds for M1/M2/M3 Macs
# Hot reload with cargo-watch, minimal dependencies
# Stack: Rust + Firebase + R2 (no PostgreSQL)
# =============================================================================

# Use Ubuntu 24.04 for OpenCV 4.12.0 compatibility (pre-built artifacts)
# Ubuntu has better ARM64 compatibility and faster builds than Alpine
FROM ubuntu:24.04 AS dev

# Build arguments for cache busting and metadata
ARG TARGETARCH
ARG BUILDPLATFORM

LABEL org.opencontainers.image.title="ViralClip Dev" \
      org.opencontainers.image.description="Development container for ViralClip Rust backend"

# Install minimal development dependencies
# - build-essential: C compiler for native deps
# - pkg-config: for linking native libraries
# - libssl-dev: OpenSSL for TLS
# - ffmpeg: video processing (worker) - includes ffprobe
# - git: for cargo dependencies from git
# - ca-certificates: HTTPS/TLS
# - python3-pip: for yt-dlp installation
# - libtbb12: Threading Building Blocks runtime for OpenCV
# - libwebp7: WebP runtime for OpenCV imgcodecs
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        pkg-config \
        libssl-dev \
        ffmpeg \
        git \
        ca-certificates \
        curl \
        python3 \
        python3-pip \
        # Clang/LLVM for opencv-rust bindgen
        clang \
        libclang-dev \
        # OpenCV runtime dependencies
        libtbb12 \
        libwebp7 \
        libwebpdemux2 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Install Rust 1.87 via rustup (matches prod toolchain)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
    sh -s -- -y --profile minimal --default-toolchain 1.87.0

ENV PATH="/root/.cargo/bin:${PATH}"

# Copy and extract pre-built OpenCV 4.12.0 artifacts
COPY opencv-artifacts/opencv-4.12.0-ubuntu24.04.tar.gz /tmp/
RUN cd /usr/local && \
    tar -xzf /tmp/opencv-4.12.0-ubuntu24.04.tar.gz && \
    rm /tmp/opencv-4.12.0-ubuntu24.04.tar.gz && \
    ldconfig

# Install yt-dlp for YouTube video downloads
RUN pip3 install --no-cache-dir --break-system-packages yt-dlp

# Copy YuNet face detection models for development
# Models are committed to version control for reproducible builds
COPY backend/models/face_detection/yunet /app/backend/models/face_detection/yunet

# Install cargo-watch for hot reload (single tool, fast install)
RUN cargo install cargo-watch --locked

# Set working directory
WORKDIR /app

# Development environment variables
ENV RUST_LOG=debug,hyper=info,tower_http=info \
    RUST_BACKTRACE=full \
    CARGO_INCREMENTAL=1 \
    CARGO_NET_GIT_FETCH_WITH_CLI=true \
    # Optimize for faster incremental builds
    CARGO_BUILD_JOBS=8 \
    # Use native CPU features for M1
    RUSTFLAGS="-C target-cpu=native" \
    # =============================================================================
    # OPENCV LINKING CONFIGURATION
    # =============================================================================
    # Explicitly specify which OpenCV libraries to link against.
    # This prevents the opencv-rust crate from using pkg-config/cmake auto-discovery
    # which finds references to contrib modules (alphamat, barcode, cvv, hdf, viz)
    # that we intentionally excluded in our custom OpenCV 4.12.0 build.
    # =============================================================================
    OPENCV_LINK_LIBS="opencv_core,opencv_imgproc,opencv_imgcodecs,opencv_videoio,opencv_objdetect,opencv_dnn,opencv_calib3d,opencv_features2d,opencv_flann,opencv_photo,opencv_video,opencv_highgui,opencv_ml,opencv_stitching,opencv_aruco,opencv_bgsegm,opencv_bioinspired,opencv_ccalib,opencv_dnn_objdetect,opencv_dnn_superres,opencv_dpm,opencv_face,opencv_freetype,opencv_fuzzy,opencv_hfs,opencv_img_hash,opencv_intensity_transform,opencv_line_descriptor,opencv_mcc,opencv_optflow,opencv_phase_unwrapping,opencv_plot,opencv_quality,opencv_rapid,opencv_reg,opencv_saliency,opencv_shape,opencv_stereo,opencv_structured_light,opencv_superres,opencv_surface_matching,opencv_text,opencv_tracking,opencv_videostab,opencv_wechat_qrcode,opencv_ximgproc,opencv_xobjdetect,opencv_xphoto"

# Create non-root user for security (optional, can run as root in dev)
# Some base images already have UID 1000, so avoid hardcoding it and make this idempotent.
RUN id -u rustdev >/dev/null 2>&1 || useradd -m -s /bin/bash rustdev

# Source code mounted via volume - no COPY needed
# Target directory should be a named volume for persistence

# Health check for the API
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Default command: hot reload API server
# Worker can override with: cargo watch -x "run --bin vclip-worker"
CMD ["cargo", "watch", \
     "--why", \
     "--clear", \
     "-x", "run --bin vclip-api", \
     "-i", "target/", \
     "-i", ".git/", \
     "-i", "*.md"]
