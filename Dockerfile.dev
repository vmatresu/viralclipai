# =============================================================================
# Development Dockerfile - Optimized for Apple Silicon (ARM64)
# =============================================================================
# Native ARM64 builds for M1/M2/M3 Macs
# Hot reload with cargo-watch, minimal dependencies
# Stack: Rust + Firebase + R2 (no PostgreSQL)
# =============================================================================

# Use Debian-based image for better ARM64 compatibility and faster builds
# Alpine has musl issues with some Rust crates on ARM64
FROM rust:1.87-bookworm AS dev

# Build arguments for cache busting and metadata
ARG TARGETARCH
ARG BUILDPLATFORM

LABEL org.opencontainers.image.title="ViralClip Dev" \
      org.opencontainers.image.description="Development container for ViralClip Rust backend"

# Install minimal development dependencies
# - build-essential: C compiler for native deps
# - pkg-config: for linking native libraries
# - libssl-dev: OpenSSL for TLS
# - ffmpeg: video processing (worker) - includes ffprobe
# - git: for cargo dependencies from git
# - ca-certificates: HTTPS/TLS
# - python3-pip: for yt-dlp installation
# - OpenCV dev libraries: for YuNet face detection compilation
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        pkg-config \
        libssl-dev \
        ffmpeg \
        git \
        ca-certificates \
        curl \
        python3 \
        python3-pip \
        # OpenCV development libraries for YuNet compilation
        libopencv-dev \
        libopencv-core-dev \
        libopencv-dnn-dev \
        libopencv-imgproc-dev \
        libopencv-videoio-dev \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Install yt-dlp for YouTube video downloads
RUN pip3 install --no-cache-dir --break-system-packages yt-dlp

# Download YuNet face detection models for development testing
# Block-quantized model (~6ms/frame, 0.8845 AP) - recommended for development
RUN mkdir -p /app/models && \
    curl -L -o /app/models/face_detection_yunet_2023mar_int8bq.onnx \
    "https://github.com/opencv/opencv_zoo/raw/main/models/face_detection_yunet/face_detection_yunet_2023mar_int8bq.onnx" && \
    curl -L -o /app/models/face_detection_yunet_2023mar_int8.onnx \
    "https://github.com/opencv/opencv_zoo/raw/main/models/face_detection_yunet/face_detection_yunet_2023mar_int8.onnx"

# Install cargo-watch for hot reload (single tool, fast install)
RUN cargo install cargo-watch --locked

# Set working directory
WORKDIR /app

# Development environment variables
ENV RUST_LOG=debug,hyper=info,tower_http=info \
    RUST_BACKTRACE=full \
    CARGO_INCREMENTAL=1 \
    CARGO_NET_GIT_FETCH_WITH_CLI=true \
    # Optimize for faster incremental builds
    CARGO_BUILD_JOBS=8 \
    # Use native CPU features for M1
    RUSTFLAGS="-C target-cpu=native"

# Create non-root user for security (optional, can run as root in dev)
RUN useradd -m -u 1000 -s /bin/bash rustdev

# Source code mounted via volume - no COPY needed
# Target directory should be a named volume for persistence

# Health check for the API
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Default command: hot reload API server
# Worker can override with: cargo watch -x "run --bin vclip-worker"
CMD ["cargo", "watch", \
     "--why", \
     "--clear", \
     "-x", "run --bin vclip-api", \
     "-i", "target/", \
     "-i", ".git/", \
     "-i", "*.md"]
