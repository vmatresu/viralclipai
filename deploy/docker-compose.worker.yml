# =============================================================================
# ViralClip AI - Worker Service (Standalone)
# =============================================================================
# For deployment on dedicated Worker droplet with external managed Valkey
# Usage: docker compose -f docker-compose.worker.yml up -d
# =============================================================================

services:
  worker:
    build:
      context: ..
      dockerfile: Dockerfile
      target: worker-runtime
      args:
        - BUILDKIT_INLINE_CACHE=1
      cache_from:
        - viralclipai-worker:latest
    image: viralclipai-worker:${VERSION:-latest}
    container_name: vclip-worker
    restart: unless-stopped
    stop_grace_period: 120s  # Longer for video processing
    env_file:
      - ../.env

    environment:
      # Runtime
      - RUST_LOG=${RUST_LOG:-info,tower_http=info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}
      - ENVIRONMENT=${ENVIRONMENT:-production}

      # Worker config
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}

      # Firebase/Firestore
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:?FIREBASE_PROJECT_ID required}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY:?FIREBASE_PRIVATE_KEY required}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL:?FIREBASE_CLIENT_EMAIL required}

      # Managed Valkey/Redis (Digital Ocean)
      # Format: rediss://:password@host:port (rediss:// for TLS)
      - REDIS_URL=${REDIS_URL:?REDIS_URL required}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}

      # Cloudflare R2 Storage
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL:?R2_ENDPOINT_URL required}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:?R2_ACCESS_KEY_ID required}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:?R2_SECRET_ACCESS_KEY required}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:?R2_BUCKET_NAME required}
      - R2_REGION=${R2_REGION:-auto}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-}

      # Gemini AI
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}

      # GCP Auth (for Firestore) - requires service account JSON file
      - GOOGLE_APPLICATION_CREDENTIALS=/app/firebase-service-account.json

    volumes:
      # Firebase service account for Firestore auth
      - ../firebase-service-account.json:/app/firebase-service-account.json:ro
      # Temp storage for video processing
      - worker-temp:/tmp/videos

    healthcheck:
      test: ["CMD", "pgrep", "-x", "vclip-worker"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Security (relaxed for FFmpeg file operations)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Resource limits (higher for video processing)
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8G
        reservations:
          cpus: "1"
          memory: 2G

    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"

volumes:
  worker-temp:
    name: vclip-worker-temp
    driver: local
