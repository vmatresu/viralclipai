# =============================================================================
# ViralClip AI - Worker Service (Standalone)
# =============================================================================
# For deployment on dedicated Worker droplet with external managed Valkey
# Usage: docker compose -f docker-compose.worker.yml up -d
# =============================================================================

services:
  worker:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: Dockerfile
      target: worker-runtime
      args:
        BUILDKIT_INLINE_CACHE: 1
        SERVICE_TYPE: worker
        OPENCV_TARBALL: opencv-4.12.0-openvino-tuned.tar.gz
      cache_from:
        - viralclipai-worker:latest
    image: viralclipai-worker:${VERSION:-latest}
    container_name: vclip-worker
    restart: unless-stopped
    stop_grace_period: 120s # Longer for video processing
    env_file:
      - ../.env

    environment:
      # Runtime
      - RUST_LOG=${RUST_LOG:-info,tower_http=info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}
      - ENVIRONMENT=${ENVIRONMENT:-production}

      # Worker config - Ryzen 9700X optimized (8 physical cores, AVX-512 VNNI)
      # Neural analysis runs on physical cores (0-7) via OpenVINO threading
      # FFmpeg encoding runs on SMT cores (8-15) via taskset
      - WORKER_MAX_JOBS=${WORKER_MAX_JOBS:-4}
      - WORKER_MAX_FFMPEG=${WORKER_MAX_FFMPEG:-8}
      - WORKER_MAX_SCENE_PARALLEL=${WORKER_MAX_SCENE_PARALLEL:-4}
      - WORKER_MAX_NEURAL_PARALLEL=${WORKER_MAX_NEURAL_PARALLEL:-4}
      - WORKER_NEURAL_CPU_THREADS=${WORKER_NEURAL_CPU_THREADS:-8}
      - WORKER_MAX_DOWNLOAD_PARALLEL=${WORKER_MAX_DOWNLOAD_PARALLEL:-2}
      - WORKER_FFMPEG_CPU_CORES=${WORKER_FFMPEG_CPU_CORES:-8-15}
      - WORKER_WORK_DIR=/tmp/videos

      # Firebase/Firestore
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:?FIREBASE_PROJECT_ID required}

      # Managed Valkey/Redis (Digital Ocean)
      # Format: rediss://:password@host:port (rediss:// for TLS)
      - REDIS_URL=${REDIS_URL:?REDIS_URL required}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}

      # Cloudflare R2 Storage
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL:?R2_ENDPOINT_URL required}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:?R2_ACCESS_KEY_ID required}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:?R2_SECRET_ACCESS_KEY required}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:?R2_BUCKET_NAME required}
      - R2_REGION=${R2_REGION:-auto}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-}

      # Gemini AI
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}

      # GCP Auth (for Firestore) - requires service account JSON file
      - GOOGLE_APPLICATION_CREDENTIALS=/app/firebase-credentials.json

    volumes:
      # Firebase service account for Firestore auth
      - ../firebase-credentials.json:/app/firebase-credentials.json:ro
      # YouTube cookies for yt-dlp authentication (writable so yt-dlp can update them)
      - ../youtube-cookies.txt:/app/youtube-cookies.txt
      # Temp storage for video processing
      - worker-temp:/tmp/videos

    healthcheck:
      test: ["CMD", "pgrep", "-x", "vclip-worker"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    # Large tmpfs for temp files (not video processing which uses volume)
    # 10GB allows for transient processing artifacts
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=10g

    # Performance Tuning for Ryzen 9700X (8 physical cores / 16 threads)
    # Allow access to ALL cores - CPU affinity is managed at the process level:
    # - Neural analysis (OpenVINO): pinned to cores 0-7 via OMP_NUM_THREADS
    # - FFmpeg encoding: pinned to cores 8-15 via taskset (WORKER_FFMPEG_CPU_CORES)
    # This separation eliminates contention between AVX-512 neural workloads and encoding
    cpuset: "0-15"

    # Resource limits - use all 16 threads for parallel processing
    deploy:
      resources:
        limits:
          cpus: "${WORKER_CPU_LIMIT:-16}"
          memory: "${WORKER_MEMORY_LIMIT:-56G}"
        reservations:
          cpus: "8"
          memory: 8G

    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"

volumes:
  worker-temp:
    name: vclip-worker-temp
    driver: local
