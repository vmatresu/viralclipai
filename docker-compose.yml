# =============================================================================
# ViralClip AI - Production Docker Compose
# =============================================================================
# Stack: Rust API + Worker + Redis (Firebase/R2 external services)
# Target: Ubuntu AMD64 production servers
#
# Services:
#   - api:    Axum HTTP/WebSocket server (distroless, ~30MB)
#   - worker: Video processing with FFmpeg (debian-slim, ~150MB)
#   - redis:  Job queue and caching
#
# Usage:
#   docker compose up -d --build
#   docker compose logs -f api worker
#   docker compose down
#
# Multi-arch build (from M1 Mac for Ubuntu prod):
#   docker buildx build --platform linux/amd64 -t viralclipai-api:latest --target api-runtime .
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Service - Axum HTTP/WebSocket Server
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api-runtime
      # Enable BuildKit caching
      cache_from:
        - type=registry,ref=viralclipai-api:cache
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: viralclipai-api:${VERSION:-latest}
    container_name: vclip-api
    restart: unless-stopped

    # Graceful shutdown for WebSocket connections
    stop_grace_period: 30s

    environment:
      # Runtime
      - RUST_LOG=${RUST_LOG:-info,tower_http=info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}
      - ENVIRONMENT=${ENVIRONMENT:-production}

      # API Server
      - API_HOST=0.0.0.0
      - API_PORT=8000

      # Firebase/Firestore (service account)
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:?FIREBASE_PROJECT_ID required}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/firebase-credentials.json

      # Redis (internal network with auth)
      # NOTE: REDIS_PASSWORD must be set in production!
      - REDIS_URL=redis://:${REDIS_PASSWORD:-}@redis:6379
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}

      # Cloudflare R2 Storage
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL:?R2_ENDPOINT_URL required}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:?R2_ACCESS_KEY_ID required}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:?R2_SECRET_ACCESS_KEY required}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:?R2_BUCKET_NAME required}
      - R2_REGION=${R2_REGION:-auto}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-}

      # JWT Authentication
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET required}

    volumes:
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro

    ports:
      - "${API_PORT:-8000}:8000"

    networks:
      - vclip-network

    depends_on:
      redis:
        condition: service_healthy

    # Distroless doesn't have wget/curl, use /health endpoint check via TCP
    healthcheck:
      test: ["CMD", "/app/vclip-api", "--health-check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
      # Production scaling
      replicas: ${API_REPLICAS:-1}

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
        compress: "true"
        tag: "{{.Name}}"

  # ---------------------------------------------------------------------------
  # Worker Service - Video Processing with FFmpeg
  # ---------------------------------------------------------------------------
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: worker-runtime
      cache_from:
        - type=registry,ref=viralclipai-worker:cache
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: viralclipai-worker:${VERSION:-latest}
    container_name: vclip-worker
    restart: unless-stopped

    # Longer grace period for video processing
    stop_grace_period: 60s

    environment:
      # Runtime
      - RUST_LOG=${RUST_LOG:-info,tower_http=info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}
      - ENVIRONMENT=${ENVIRONMENT:-production}

      # Worker config
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}

      # Firebase/Firestore
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/firebase-credentials.json

      # Redis (with auth)
      # NOTE: REDIS_PASSWORD must be set in production!
      - REDIS_URL=redis://:${REDIS_PASSWORD:-}@redis:6379
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-10}

      # Cloudflare R2 Storage
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_REGION=${R2_REGION:-auto}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-}

      # Gemini AI
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}

    networks:
      - vclip-network

    volumes:
      # Temp storage for video processing (use tmpfs in prod for speed)
      - worker-temp:/tmp/videos
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro

    depends_on:
      redis:
        condition: service_healthy

    # Security (relaxed for FFmpeg file operations)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Resource limits (higher for video processing)
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 4G
        reservations:
          cpus: "1"
          memory: 1G
      replicas: ${WORKER_REPLICAS:-1}

    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"
        tag: "{{.Name}}"

  # ---------------------------------------------------------------------------
  # Redis - Job Queue & Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: vclip-redis
    restart: unless-stopped

    # Production Redis config with password authentication
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory ${REDIS_MAXMEMORY:-512mb}
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
      --requirepass ${REDIS_PASSWORD:-changeme}

    # No external ports in production - only accessible via internal network
    # Uncomment for local debugging only:
    # ports:
    #   - "127.0.0.1:6379:6379"

    volumes:
      - redis-data:/data

    networks:
      - vclip-network

    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "-a",
          "${REDIS_PASSWORD:-changeme}",
          "--no-auth-warning",
          "ping",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=50m

    deploy:
      resources:
        limits:
          cpus: "1"
          memory: ${REDIS_MAXMEMORY:-512M}
        reservations:
          cpus: "0.25"
          memory: 256M

    logging:
      driver: json-file
      options:
        max-size: "25m"
        max-file: "3"
        compress: "true"

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  vclip-network:
    name: vclip-network
    driver: bridge

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  redis-data:
    name: vclip-redis-data
    driver: local

  worker-temp:
    name: vclip-worker-temp
    driver: local
